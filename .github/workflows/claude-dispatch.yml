# IMPORTANT: Do not move this file in your repo! Make sure it's located at .github/workflows/claude-dispatch.yml
name: Claude Code Dispatch

# IMPORTANT: Do not modify this `on` section!
on:
  repository_dispatch:
    types: [claude-dispatch]

jobs:
  claude-dispatch:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write 
      issues: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install uv
        uses: astral-sh/setup-uv@v4
          
      - name: Set up environment
        run: |
          # Install dependencies
          uv sync -q

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@eap
        with:
          mode: 'remote-agent'
          
          # Optional: Specify an API key, otherwise we'll use your Claude account automatically
          # anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          # Optional: Specify model (defaults to Claude Sonnet 4, uncomment for Claude Opus 4)
          # model: "claude-opus-4-20250514"
          model: "claude-opus-4-1-20250805"

          # Optional: Allow Claude to run specific commands
          # allowed_tools: |
            # Bash(npm run lint)
            # Bash(npm run test)
            # Bash(npm run build)

          allowed_tools: |
            WebFetch(domain:*)
            WebFetch(domain:textual.textualize.io)
            WebFetch(domain:github.com)
            WebSearch(query:*)
            Bash(alembic:*)
            Bash(source:*)
            Bash(python:*)
            Bash(python3:*)
            Bash(ruff check:*)
            Bash(ruff format:*)
            Bash(pyright:*)
            Bash(pytest:*)
            Bash(uv:*)
            Bash(rg:*)
            Bash(ls:*)
            Bash(grep:*)
            Bash(find:*)
            Bash(sed:*)
            Bash(chmod:*)
            Bash(rm:*)
            Bash(mkdir:*)
            Bash(curl:*)
            Bash(test:*)
            Bash(tree:*)
            Bash(uv run ruff format && uv run ruff check && uv run pyright . && uv run pytest)

          # Optional: Custom environment variables for Claude
          # claude_env: |
          #   NODE_ENV: test